GAE/Go & Firestore

12 Sep 2020
Tags: Go

Daigo Ikeda
Knightso, LLC
@hogedigo

* Profile

Daigo Ikeda
@hogedigo

Knightso, LLC
http://www.knightso.co.jp/
Shizuoka, JAPAN

.image ./firestoretx/images/hogecat.jpg 

* æ¦‚è¦

- GAE/Go
- Cloud Firestore
- Firestoreãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã“ã‚ŒãŒãƒ¡ã‚¤ãƒ³ï¼‰

* GAE/Go

* What is GAE?

- Google App Engine
- Google Cloud Platformã®æä¾›ã™ã‚‹PAAS
- è² è·ã«å¿œã˜ã¦è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒ«
- å¾“é‡èª²é‡‘ã€‚ç„¡æ–™æ ã‚ã‚Š
- Standard/Flexible Environment

* GAE Standard Environment(SE)

- Python, Java, Node.js, PHP, Ruby, Go
- First/Second generation

* GAE Second generation(2nd gen)

- gVisor
- å¤–éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¯ã‚»ã‚¹
- /tmp ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿/æ›¸ãè¾¼ã¿
- App Engine APIã¯ä½¿ãˆãªã„ï¼ˆClient Libraryã‚„3rd party APIã‚’åˆ©ç”¨ï¼‰

* GAE/Go(SE)

- 1st gen - 1.11 ï¼ˆä½†ã—ãƒ¯ã‚±ã‚ã‚Šï¼‰
- 2nd gen - 1.12+
- æœ€æ–°ã¯1.14

FYI:
- [[https://qiita.com/apstndb/items/314e461aed518a4ad26f][GAE Go 1.11 ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒå…¬å¼ã«ã¯ 2nd gen ã§ã¯ãªããªã£ãŸä»¶ã«ã¤ã„ã¦]]

* Cloud Firestore

* What is Firestore?

- Native/Datastore mode
- Native mode - ä¸»ã«Firebaseå‘ã‘
- Datastore modeã¯æ—§Datastoreã®å¾Œç¶™ï¼ˆæœ¬æ—¥æ‰±ã†ã®ã¯ã“ã¡ã‚‰ï¼‰

* æ—§DatastoreãŠã•ã‚‰ã„

.link /2014/gaego_introduction.slide

æ‰‹æŠœãã‚¹ãƒŸãƒã‚»ãƒ³ğŸ™‡ğŸ™‡ğŸ™‡

* Firestore in Datastore mode

- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ã‚¨ãƒªãŒå¼·æ•´åˆã«
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ã‚¨ãƒªå‘¼ã³å‡ºã—OK
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®25ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—åˆ¶é™æ’¤å»ƒ
- åŒä¸€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—æ›¸ãè¾¼ã¿ 1/secåˆ¶é™æ’¤å»ƒ
- æ¥½è¦³çš„æ’ä»–åˆ¶å¾¡â†’æ‚²è¦³çš„ãƒ­ãƒƒã‚¯

* Firestoreãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

* Firestoreãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’è©¦ã—ã¦ã¿ã‚‹

- ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰Datastore Client Libraryã‚’ä½¿ç”¨
- å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ã‚‹å†…å®¹ã«æ²¿ã£ã¦æ¤œè¨¼

.link https://cloud.google.com/datastore/docs/concepts/transactions

* Atomic

.link https://cloud.google.com/datastore/docs/concepts/transactions

> Each transaction is guaranteed to be atomic, meaning that transactions are never partially applied. Either all of the operations in the transaction are applied, or none of them are applied.

- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¯ã€å¿…ãšå…¨ã¦ãŒæˆåŠŸã™ã‚‹ã‹ã€å…¨ã¦ãŒå¤±æ•—ã™ã‚‹

* Atomic - OK

.link ./firestoretx/src/fstx/atomic/main.go

- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ï¼’ã¤ç™»éŒ²

* 

*å®Ÿè¡Œçµæœ*

.image ./firestoretx/images/atomic_ok.png

* Atomic - Rollback

.link ./firestoretx/src/fstx/rollback/main.go

- OKã¨åŒã˜å‡¦ç†
- ã‚³ãƒŸãƒƒãƒˆå‰ã«ã‚ã–ã¨ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™

* 

*å®Ÿè¡Œçµæœ*

 2020/08/21 04:04:46 ã‚ã–ã¨ã‚¨ãƒ©ãƒ¼
 exit status 1

.image ./firestoretx/images/rollback.png 300 _

* 500ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Put

> Transactions can query or lookup any number of entities. You can create, update, or delete up to 500 entities in each transaction.

- ç™»éŒ²ãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã¯1ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§500ã¾ã§

* 500ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Put - OK

.link ./firestoretx/src/fstx/maxentities/main.go

* 

*å®Ÿè¡Œçµæœ*

.image ./firestoretx/images/max_ok.png 400 _

* 501ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Put - NG

- å‰å›ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦å®Ÿè¡Œ

 for i := 0; i < 501; i++ {

* 

*å®Ÿè¡Œçµæœ*

 2020/08/22 14:29:17 rpc error: code = InvalidArgument desc = cannot write more than 500 entities
 in a single call
 exit status 1

- GAE/Go 1st genã§appengine/datastoreãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã ã¨ã“ã®åˆ¶é™ã¯ãªã„

* ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ã‚¨ãƒª

.link Queries in transactions are no longer required to be ancestor queries.

> Queries in transactions are no longer required to be ancestor queries.

- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ã‚¨ãƒªï¼ˆéç¥–å…ˆã‚¯ã‚¨ãƒªï¼‰ã‚’å®Ÿè¡Œå¯èƒ½

* ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ã‚¨ãƒª- OK

.link ./firestoretx/src/fstx/query/main.go

* 

*å®Ÿè¡Œçµæœ*

 done. total:500

* Locks

* Locks

.link https://cloud.google.com/datastore/docs/concepts/transactions#transaction_locks

> Read-write transactions use reader/writer locks to enforce isolation and serializability. When two concurrent read-write transactions read or write the same data, the lock held by one transaction can delay the other transaction.

- ï¼’ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŒæ™‚ã«åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’readã¾ãŸã¯writeã—ãŸå ´åˆã€ç‰‡æ–¹ãŒãƒ­ãƒƒã‚¯ã‚’å–å¾—ã—ã‚‚ã†ç‰‡æ–¹ãŒãã‚Œã‚’å¾…æ©Ÿã™ã‚‹
- ï¼ˆå‚è€ƒï¼‰æ—§Datastoreã§ã¯æ¥½è¦³çš„æ’ä»–

* 

æ¤œè¨¼ã‚³ãƒ¼ãƒ‰ï¼ˆå„ã‚±ãƒ¼ã‚¹å…±é€šï¼‰

.link ./firestoretx/src/fstx/locks/main.go

* Locks - Get vs Get

- å˜ç´”ãªGetã‚’ä¸¦åˆ—ã§å®Ÿè¡Œï¼ˆå¿…è¦ãªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¯äºˆã‚Putã—ã¦ãŠãï¼‰
- æœ€åˆã«å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆãƒ—ãƒ­ã‚»ã‚¹1ï¼‰ã§ã‚³ãƒŸãƒƒãƒˆå‰ã«sleep
- å¾Œã‹ã‚‰å®Ÿè¡Œã™ã‚‹ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆãƒ—ãƒ­ã‚»ã‚¹2ï¼‰ã¯å³ã‚³ãƒŸãƒƒãƒˆã—ã¾ã™ã€‚

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s Get
 2020/09/12 15:20:43 start
 2020/09/12 15:20:44 getting...
 2020/09/12 15:20:44 got {Value:1 CreatedAt:2020-09-10 14:19:37.872402 +0900 JST}
 2020/09/12 15:20:44 sleeping... 20s
 2020/09/12 15:21:04 commiting...
 2020/09/12 15:21:04 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks Get
 2020/09/12 15:20:47 start
 2020/09/12 15:20:48 getting...
 2020/09/12 15:20:48 got {Value:1 CreatedAt:2020-09-10 14:19:37.872402 +0900 JST}
 2020/09/12 15:20:48 sleeping... 0s
 2020/09/12 15:20:48 commiting...
 2020/09/12 15:20:48 done.

* 

- ãƒ­ãƒƒã‚¯ã¯ã‹ã‹ã‚‰ãªã„
- ãƒ—ãƒ­ã‚»ã‚¹2ã«sleepã‚’å…¥ã‚Œã¦å¾Œã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆã™ã‚‹æ§˜ã«ã—ã¦ã‚‚åŒæ§˜

* Locks - Get vs Put

- ãƒ—ãƒ­ã‚»ã‚¹1ã¯Getã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã§Putã€å³ã‚³ãƒŸãƒƒãƒˆ

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s Get
 2020/09/12 16:17:38 start
 2020/09/12 16:17:38 getting...
 2020/09/12 16:17:38 got {Value:1 CreatedAt:2020-09-10 14:19:37.872402 +0900 JST}
 2020/09/12 16:17:38 sleeping... 20s
 2020/09/12 16:17:58 commiting...
 2020/09/12 16:17:58 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks Put
 2020/09/12 16:17:43 start
 2020/09/12 16:17:43 putting...
 2020/09/12 16:17:43 sleeping... 0s
 2020/09/12 16:17:43 commiting...
 2020/09/12 16:17:58 done.

* 

- ãƒ—ãƒ­ã‚»ã‚¹2ï¼ˆPutï¼‰ã®ã‚³ãƒŸãƒƒãƒˆã§ãƒ­ãƒƒã‚¯å¾…æ©Ÿ
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

ã¡ãªã¿ã«ãƒ»ãƒ»

- æ—§Datastoreã®å ´åˆã¯ãƒ­ãƒƒã‚¯å¾…æ©Ÿãªã—ã§æ­£å¸¸çµ‚äº†

* Locks - Put vs Get

- ãƒ—ãƒ­ã‚»ã‚¹1ã¯Putã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã§Getã€å³ã‚³ãƒŸãƒƒãƒˆ

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s Put
 2020/09/12 16:26:54 start
 2020/09/12 16:26:55 putting...
 2020/09/12 16:26:55 sleeping... 20s
 2020/09/12 16:27:15 commiting...
 2020/09/12 16:27:15 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks Get
 2020/09/12 16:26:59 start
 2020/09/12 16:27:00 getting...
 2020/09/12 16:27:00 got {Value:1 CreatedAt:2020-09-10 16:24:57.462099 +0900 JST}
 2020/09/12 16:27:00 sleeping... 0s
 2020/09/12 16:27:00 commiting...
 2020/09/12 16:27:00 done.

* 

- ãƒ­ãƒƒã‚¯å¾…æ©Ÿãªã—
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

* Locks - Put vs Getï¼ˆãã®ï¼’ï¼‰

- ãƒ—ãƒ­ã‚»ã‚¹1ã¯Putã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã§Getã€ã“ã¡ã‚‰ã‚‚sleep

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s Put
 2020/09/12 05:09:08 start
 2020/09/12 05:09:09 putting...
 2020/09/12 05:09:09 sleeping... 20s
 2020/09/12 05:09:29 commiting...
 2020/09/12 05:09:36 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks -s 20s Get
 2020/09/12 05:09:15 start
 2020/09/12 05:09:16 getting...
 2020/09/12 05:09:16 got {Value:1 CreatedAt:2020-09-11 05:03:01.615712 +0900 JST}
 2020/09/12 05:09:16 sleeping... 20s
 2020/09/12 05:09:36 commiting...
 2020/09/12 05:09:36 done.

* 

- ãƒ—ãƒ­ã‚»ã‚¹1ãŒãƒ—ãƒ­ã‚»ã‚¹2ï¼ˆGetï¼‰ã®ã‚³ãƒŸãƒƒãƒˆã¾ã§ãƒ­ãƒƒã‚¯å¾…æ©Ÿ
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

* Locks - Put vs Put

- ãƒ—ãƒ­ã‚»ã‚¹1ã¯Putã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã§Putã€å³ã‚³ãƒŸãƒƒãƒˆ

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s Put
 2020/09/12 03:21:30 start
 2020/09/12 03:21:31 putting...
 2020/09/12 03:21:31 sleeping... 20s
 2020/09/12 03:21:51 commiting...
 2020/09/12 03:21:51 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks Put
 2020/09/12 03:21:35 start
 2020/09/12 03:21:36 putting...
 2020/09/12 03:21:36 sleeping... 0s
 2020/09/12 03:21:36 commiting...
 2020/09/12 03:21:36 done.

* 

- ãƒ­ãƒƒã‚¯å¾…æ©Ÿãªã—ï¼ï¼ğŸ˜³
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

* Locks - Get&Put vs Get

- ãƒ—ãƒ­ã‚»ã‚¹1ã§ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¸€åº¦Getã—ãŸã®ã¡Putã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã§Getã€å³ã‚³ãƒŸãƒƒãƒˆ

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s GetPut
 2020/09/12 04:14:49 start
 2020/09/12 04:14:49 getting...
 2020/09/12 04:14:49 got {Value:1 CreatedAt:2020-09-11 04:00:30.603741 +0900 JST}
 2020/09/12 04:14:49 putting...
 2020/09/12 04:14:49 sleeping... 20s
 2020/09/12 04:15:09 commiting...
 2020/09/12 04:15:10 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks Get
 2020/09/12 04:14:52 start
 2020/09/12 04:14:53 getting...
 2020/09/12 04:14:53 got {Value:1 CreatedAt:2020-09-11 04:00:30.603741 +0900 JST}
 2020/09/12 04:14:53 sleeping... 0s
 2020/09/12 04:14:53 commiting...
 2020/09/12 04:14:53 done.

* 

- ãƒ­ãƒƒã‚¯å¾…æ©Ÿãªã—
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

* Locks - Get vs Get&Put

- ãƒ—ãƒ­ã‚»ã‚¹1ã§ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’Getã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã¯ãã®é–“ã«Getï¼†Putã—ã¦å³ã‚³ãƒŸãƒƒãƒˆ

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s Get
 2020/09/12 04:18:39 start
 2020/09/12 04:18:40 getting...
 2020/09/12 04:18:40 got {Value:1 CreatedAt:2020-09-11 04:18:10.5811 +0900 JST}
 2020/09/12 04:18:40 sleeping... 20s
 2020/09/12 04:19:00 commiting...
 2020/09/12 04:19:00 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks GetPut
 2020/09/12 04:18:45 start
 2020/09/12 04:18:45 getting...
 2020/09/12 04:18:45 got {Value:1 CreatedAt:2020-09-11 04:18:10.5811 +0900 JST}
 2020/09/12 04:18:45 putting...
 2020/09/12 04:18:45 sleeping... 0s
 2020/09/12 04:18:45 commiting...
 2020/09/12 04:19:00 done.

* 

- ãƒ—ãƒ­ã‚»ã‚¹2ãŒãƒ­ãƒƒã‚¯å¾…æ©Ÿ
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

* Locks - Get&Put vs Put

- ãƒ—ãƒ­ã‚»ã‚¹1ã§ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’Get&Putã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã¯ãã®é–“ã«Putã—ã¦å³ã‚³ãƒŸãƒƒãƒˆ

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s GetPut
 2020/09/12 04:21:44 start
 2020/09/12 04:21:44 getting...
 2020/09/12 04:21:44 got {Value:1 CreatedAt:2020-09-11 04:18:45.825498 +0900 JST}
 2020/09/12 04:21:44 putting...
 2020/09/12 04:21:44 sleeping... 20s
 2020/09/12 04:22:04 commiting...
 2020/09/12 04:22:05 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks Put
 2020/09/12 04:21:49 start
 2020/09/12 04:21:50 putting...
 2020/09/12 04:21:50 sleeping... 0s
 2020/09/12 04:21:50 commiting...
 2020/09/12 04:22:05 done.

* 

- ãƒ—ãƒ­ã‚»ã‚¹2ãŒãƒ­ãƒƒã‚¯å¾…æ©Ÿ
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

* Locks - Put vs Get&Put

- ãƒ—ãƒ­ã‚»ã‚¹1ã§ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’Putã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã¯ãã®é–“ã«Getï¼†Putã—ã¦å³ã‚³ãƒŸãƒƒãƒˆ

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s Put
 2020/09/12 04:32:43 start
 2020/09/12 04:32:44 putting...
 2020/09/12 04:32:44 sleeping... 20s
 2020/09/12 04:33:04 commiting...
 2020/09/12 04:33:04 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks GetPut
 2020/09/12 04:32:48 start
 2020/09/12 04:32:48 getting...
 2020/09/12 04:32:48 got {Value:1 CreatedAt:2020-09-11 04:31:50.387902 +0900 JST}
 2020/09/12 04:32:48 putting...
 2020/09/12 04:32:48 sleeping... 0s
 2020/09/12 04:32:48 commiting...
 2020/09/12 04:32:48 done.

* 

- ãƒ­ãƒƒã‚¯å¾…æ©Ÿãªã—
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

* Locks - Put vs Get&Putï¼ˆãã®ï¼’ï¼‰

- ãƒ—ãƒ­ã‚»ã‚¹1ã§ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’Putã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã¯Getï¼†Putã—ã¦ã“ã¡ã‚‰ã‚‚sleepã€‚ã•ã‚‰ã«æ›¸ãè¾¼ã‚€å€¤ã‚‚å¤‰æ›´

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s -v 2 Put
 2020/09/12 04:41:10 start
 2020/09/12 04:41:11 putting...
 2020/09/12 04:41:11 sleeping... 20s
 2020/09/12 04:41:31 commiting...
 2020/09/12 04:41:36 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks -s 20s -v 3 GetPut
 2020/09/12 04:41:16 start
 2020/09/12 04:41:16 getting...
 2020/09/12 04:41:16 got {Value:1 CreatedAt:2020-09-11 04:41:05.819933 +0900 JST}
 2020/09/12 04:41:16 putting...
 2020/09/12 04:41:16 sleeping... 20s
 2020/09/12 04:41:36 commiting...
 2020/09/12 04:41:36 done.

* 

- ãƒ—ãƒ­ã‚»ã‚¹1ãŒãƒ—ãƒ­ã‚»ã‚¹2ã®ã‚³ãƒŸãƒƒãƒˆã¾ã§ãƒ­ãƒƒã‚¯å¾…æ©Ÿ
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†
- æœ€çµ‚çš„ã«ä¿å­˜ã•ã‚ŒãŸå€¤ã¯ãƒ—ãƒ­ã‚»ã‚¹1ã®æ›¸ãè¾¼ã‚“ã Value=2


ã¡ãªã¿ã«æ—§Datastoreã ã¨ãƒ»ãƒ»

- ãƒ­ãƒƒã‚¯å¾…æ©Ÿãªã—
- ãƒ—ãƒ­ã‚»ã‚¹1ã¯å³æˆåŠŸçµ‚äº†
- ãƒ—ãƒ­ã‚»ã‚¹2ã¯concurrent transactionã‚¨ãƒ©ãƒ¼

* Locks - Get&Put vs Get&Put

- ãƒ—ãƒ­ã‚»ã‚¹1ã§ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’Get&Putã—ã¦sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ã‚‚Getï¼†Putã—ã¦å³ã‚³ãƒŸãƒƒãƒˆ

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s GetPut
 2020/09/12 09:14:44 start
 2020/09/12 09:14:45 getting...
 2020/09/12 09:14:45 got {Value:1 CreatedAt:2020-09-11 08:43:20.957081 +0900 JST}
 2020/09/12 09:14:45 putting...
 2020/09/12 09:14:45 sleeping... 20s
 2020/09/12 09:15:05 commiting...
 2020/09/12 09:15:05 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks GetPut
 2020/09/12 09:14:50 start
 2020/09/12 09:14:50 getting...
 2020/09/12 09:14:50 got {Value:1 CreatedAt:2020-09-11 08:43:20.957081 +0900 JST}
 2020/09/12 09:14:50 putting...
 2020/09/12 09:14:50 sleeping... 0s
 2020/09/12 09:14:50 commiting...
 2020/09/12 09:15:05 datastore: concurrent transaction

* 

- ãƒ—ãƒ­ã‚»ã‚¹1ã¯æ­£å¸¸çµ‚äº†
- ãƒ—ãƒ­ã‚»ã‚¹2ã¯ãƒ—ãƒ­ã‚»ã‚¹1ã®ã‚³ãƒŸãƒƒãƒˆå®Œäº†ã¾ã§ãƒ­ãƒƒã‚¯ã—ã€concurrent transactionã‚¨ãƒ©ãƒ¼


ã¡ãªã¿ã«æ—§Datastoreã ã¨ãƒ»ãƒ»

- ãƒ­ãƒƒã‚¯å¾…æ©Ÿãªã—
- ãƒ—ãƒ­ã‚»ã‚¹1ã¯å³æ™‚æ­£å¸¸çµ‚äº†
- ãƒ—ãƒ­ã‚»ã‚¹2ãŒconcurrent transactionã‚¨ãƒ©ãƒ¼

* Locks - Mutation:  Getã€ Updateã€ï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå­˜åœ¨ã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã®ï¼‰Upsert

- Getã€Putã¨åŒã˜çµ„ã¿åˆã‚ã›ã‚’æ¤œè¨¼ã—ã¦åŒã˜æŒ™å‹•

* Locks - Mutation: Insert vs Insert

- ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹
- ãƒ—ãƒ­ã‚»ã‚¹1, 2ä¸¡æ–¹ã‹ã‚‰Insert

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s Insert
 2020/09/12 09:36:43 start
 2020/09/12 09:36:44 inserting...
 2020/09/12 09:36:44 sleeping... 20s
 2020/09/12 09:37:04 commiting...
 2020/09/12 09:37:04 rpc error: code = AlreadyExists desc = entity already exists: app: "b~kni-fs-tx-test"
 path <
   Element {
     type: "Sample"
     name: "test"
   }
 >

* 

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks Insert
 2020/09/12 09:36:48 start
 2020/09/12 09:36:49 inserting...
 2020/09/12 09:36:49 sleeping... 0s
 2020/09/12 09:36:49 commiting...
 2020/09/12 09:36:49 done.

- ãƒ—ãƒ­ã‚»ã‚¹2ã¯å³æ™‚æ­£å¸¸çµ‚äº†
- ãƒ—ãƒ­ã‚»ã‚¹1ã¯ã‚³ãƒŸãƒƒãƒˆæ™‚ã«AlreadyExistsã¨ã„ã†ã‚¨ãƒ©ãƒ¼
- ãƒ—ãƒ­ã‚»ã‚¹2ã«sleepã‚’è¨­å®šã™ã‚‹ã¨ã€ä»Šåº¦ã¯ãƒ—ãƒ­ã‚»ã‚¹2ãŒAlreadyExistsã‚¨ãƒ©ãƒ¼ã«ï¼ˆã‚³ãƒŸãƒƒãƒˆå…ˆå‹ã¡?ï¼‰

* Locks - Query & Put

- äºˆã‚KeyåãŒA, B, Cã®ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”¨æ„
- ãƒ—ãƒ­ã‚»ã‚¹1ãŒ A <= key <= C ã§ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã€10ç§’sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ãŒå¾Œã‹ã‚‰KeyåAAã§ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’Put

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks/locks -sa 10s Query
 2020/09/12 17:10:47 start
 2020/09/12 17:10:47 sleeping... 0s
 2020/09/12 17:10:47 querying...
 2020/09/12 17:10:48 0: &{Value:1 UpdatedAt:2020-09-11 16:22:50.11876 +0900 JST}
 2020/09/12 17:10:48 1: &{Value:2 UpdatedAt:2020-09-11 16:22:59.032873 +0900 JST}
 2020/09/12 17:10:48 2: &{Value:3 UpdatedAt:2020-09-11 16:23:08.504272 +0900 JST}
 2020/09/12 17:10:48 sleeping... 10s
 2020/09/12 17:10:58 committing...
 2020/09/12 17:10:58 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks/locks -k AA Put
 2020/09/12 16:55:26 start
 2020/09/12 16:55:27 sleeping... 0s
 2020/09/12 16:55:27 putting...
 2020/09/12 16:55:27 sleeping... 0s
 2020/09/12 16:55:27 committing...
 2020/09/12 16:55:42 done.

* 

- ãƒ—ãƒ­ã‚»ã‚¹2ã¯ãƒ­ãƒƒã‚¯å¾…æ©Ÿï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ¬ãƒ³ã‚¸ãƒ­ãƒƒã‚¯?ï¼‰
- ã©ã¡ã‚‰ã‚‚æ­£å¸¸çµ‚äº†

* Locks - ã¾ã¨ã‚

- GetãŒãƒ­ãƒƒã‚¯ã‚’å–å¾—ã—ã€Putã¯ãƒ­ãƒƒã‚¯å¾…æ©Ÿã™ã‚‹
- PutåŒå£«ã ã¨ãƒ­ãƒƒã‚¯å¾…æ©Ÿã¯ç™ºç”Ÿã—ãªã„
- ãƒ­ãƒƒã‚¯å¾…æ©Ÿã¯Putæ“ä½œæ™‚ã§ã¯ãªãã‚³ãƒŸãƒƒãƒˆæ™‚ã«ç™ºç”Ÿ
- ã‚¯ã‚¨ãƒªã¯ç¯„å›²ã«å¯¾ã—ã¦ãƒ­ãƒƒã‚¯ãŒã‹ã‹ã‚‹ï¼ˆ?ï¼‰

* Isolation and consistency

* Isolation and consistency

.link https://cloud.google.com/datastore/docs/concepts/transactions#isolation_and_consistency

> Datastore mode databases enforce serializable isolation. Data read or modified by a transaction cannot be concurrently modified.

- åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã¯SERIALIZABLE

* Isolation and consistency - Put vs Get

- äºˆã‚Valueãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã‚’1ã«ã—ã¦ãŠã
- ãƒ—ãƒ­ã‚»ã‚¹1ã¯å€¤ã‚’æ›¸ãæ›ãˆã¦Putã‚’è¡Œã„20ç§’é–“sleep
- ãƒ—ãƒ­ã‚»ã‚¹2ãŒGetã—ã¦å³æ™‚çµ‚äº†

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -s 20s -v 2 Put
 2020/09/12 14:50:31 start
 2020/09/12 14:50:32 putting...
 2020/09/12 14:50:32 sleeping... 20s
 2020/09/12 14:50:52 commiting...
 2020/09/12 14:50:52 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks Get
 2020/09/12 14:50:36 start
 2020/09/12 14:50:36 getting...
 2020/09/12 14:50:36 got {Value:1 CreatedAt:2020-09-11 14:50:14.517059 +0900 JST}
 2020/09/12 14:50:36 sleeping... 0s
 2020/09/12 14:50:36 commiting...
 2020/09/12 14:50:36 done.

* 

- ãƒ—ãƒ­ã‚»ã‚¹2ã¯ã€ãƒ—ãƒ­ã‚»ã‚¹1ã®Putã—ãŸå€¤ã§ã¯ãªãã€æ›´æ–°å‰ã®å€¤ã‚’å–å¾—
- äº‹å‰ã«å¯¾è±¡ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å‰Šé™¤ã—ã¦ãŠã„ãŸå ´åˆã€ãƒ—ãƒ­ã‚»ã‚¹2ã¯no such entityã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã™ã‚‹

* Isolation and consistency - é…å»¶Get Vs Put

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸‹è¨˜ã‚’æ¤œè¨¼

> Queries and lookups in a transaction see a consistent snapshot of the state of the database. This snapshot is guaranteed to contain the effect of all transactions and writes that completed prior to the beginning of the transaction.

- äºˆã‚Valueãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã‚’1ã«
- ä»Šã¾ã§ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æ“ä½œå¾Œã«sleepã—ã¦ã„ã¾ã—ãŸãŒã€ä»Šå›ãƒ—ãƒ­ã‚»ã‚¹1ã¯ã¾ãšsleepã—ã¦ã‹ã‚‰Get
- ãƒ—ãƒ­ã‚»ã‚¹1ã®sleepä¸­ã«ãƒ—ãƒ­ã‚»ã‚¹2ã¯Put

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./locks -sb 10s Get
 2020/09/12 15:33:01 start
 2020/09/12 15:33:02 sleeping... 10s
 2020/09/12 15:33:12 getting...
 2020/09/12 15:33:12 got {Value:99 CreatedAt:2020-09-11 15:33:06.947901 +0900 JST}
 2020/09/12 15:33:12 sleeping... 0s
 2020/09/12 15:33:12 commiting...
 2020/09/12 15:33:12 done.

ãƒ—ãƒ­ã‚»ã‚¹2

 $ ./locks -v 99 Put
 2020/09/12 15:33:06 start
 2020/09/12 15:33:06 sleeping... 0s
 2020/09/12 15:33:06 putting...
 2020/09/12 15:33:06 sleeping... 0s
 2020/09/12 15:33:06 commiting...
 2020/09/12 15:33:07 done.

* 

- ãƒ—ãƒ­ã‚»ã‚¹1ã®Getã§ãƒ—ãƒ­ã‚»ã‚¹2ã®Putã—ãŸå€¤ãŒå–å¾—ã•ã‚Œã¾ã—ãŸ
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã§ã¯ãªãGetæ™‚ç‚¹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å‚ç…§ï¼ˆï¼Ÿï¼‰

* Isolation and consistency - é€£ç¶š Get vs PutMulti

1. ãƒ—ãƒ­ã‚»ã‚¹1ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
2. ãƒ—ãƒ­ã‚»ã‚¹2ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£A, B, Cã‚’PutMulti
3. ãƒ—ãƒ­ã‚»ã‚¹1ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Aã‚’å–å¾—
4. ãƒ—ãƒ­ã‚»ã‚¹3ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£B, Cã‚’PutMulti
5. ãƒ—ãƒ­ã‚»ã‚¹1ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Bã‚’å–å¾—
6. ãƒ—ãƒ­ã‚»ã‚¹4ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Cã‚’PutMulti
7. ãƒ—ãƒ­ã‚»ã‚¹1ãŒã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£Bã‚’å–å¾—

* 

*å®Ÿè¡Œçµæœ*

ãƒ—ãƒ­ã‚»ã‚¹1

 $ ./getabc
 2020/09/12 16:22:46 sleeping... 10s
 2020/09/12 16:22:56 key:/Sample,A, value:{Value:1 UpdatedAt:2020-09-11 16:22:50.11876 +0900 JST}
 2020/09/12 16:22:56 sleeping... 10s
 2020/09/12 16:23:06 key:/Sample,B, value:{Value:2 UpdatedAt:2020-09-11 16:22:59.032873 +0900 JST}
 2020/09/12 16:23:06 sleeping... 10s
 2020/09/12 16:23:16 key:/Sample,C, value:{Value:3 UpdatedAt:2020-09-11 16:23:08.504272 +0900 JST}
 done

ãƒ—ãƒ­ã‚»ã‚¹2,3,4

 $ ./putabc -v 1 A B C
 2020/09/12 16:22:50 putting value:1 into entities [A B C]
 done
 $ ./putabc -v 2 B C
 2020/09/12 16:22:59 putting value:2 into entities [B C]
 done
 $ ./putabc -v 3 C
 2020/09/12 16:23:08 putting value:3 into entities [C]
 done

* 

- ã‚„ã¯ã‚ŠGetæ™‚ç‚¹ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’å‚ç…§

* Isolation and consistency - Get&Put&Get

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸‹è¨˜ã‚’æ¤œè¨¼

> Unlike with most databases, queries and lookups inside a Datastore mode transaction do not see the results of previous writes inside that transaction. 

- ï¼‘ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§Getã€Putã€Get

* 

*å®Ÿè¡Œçµæœ*

 $ ./getputget
 2020/09/12 04:09:49 got before put: {Value:1 UpdatedAt:2020-09-12 04:09:38.084512 +0900 JST}
 2020/09/12 04:09:49 got after put: {Value:1 UpdatedAt:2020-09-12 04:09:38.084512 +0900 JST}
 done
 % ./getputget
 2020/09/12 04:09:57 got before put: {Value:2 UpdatedAt:2020-09-12 04:09:49.166701 +0900 JST}
 2020/09/12 04:09:57 got after put: {Value:2 UpdatedAt:2020-09-12 04:09:49.166701 +0900 JST}
 done

* 

- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§Putã—ãŸã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’å†åº¦Getã—ã¦ã‚‚ã€Putã—ãŸå†…å®¹ã¯å‚ç…§ã•ã‚Œãªã„
- æ—§Datastoreã§ã‚‚åŒæ§˜

* Read-only Transaction

* Read-only Transaction

TODO ğŸ™‡ğŸ™‡ğŸ™‡

* ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã®ãƒãƒã‚Šã©ã“ã‚

* RunInTransactionã¯å†ªç­‰ã«

- RunInTransactionã¯ç«¶åˆã‚¨ãƒ©ãƒ¼ã§ãƒªãƒˆãƒ©ã‚¤ã•ã‚Œã‚‹ç‚ºã€å‡¦ç†ã‚’å†ªç­‰ã«ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹
- ã¾ãŸã¯MaxAttemptsã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’1ã«ã™ã‚‹ã“ã¨ã§ãƒªãƒˆãƒ©ã‚¤ã‚’æŠ‘åˆ¶å¯èƒ½


ä¾‹ãˆã°ãƒ»ãƒ»

.link ./firestoretx/src/fstx/query/main.go

* ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è²¼ã‚Šå¿˜ã‚Œã«æ³¨æ„

.link ./firestoretx/src/fstx/notxput/main.go

.code ./firestoretx/src/fstx/notxput/main.go /START OMIT/,/END OMIT/

* 

*å®Ÿè¡Œçµæœ*

 % ./notxput
 2020/09/12 04:23:08 start
 2020/09/12 04:23:28 rpc error: code = Aborted desc = too much contention on these datastore entities. please try again.

* ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã®å¼·åˆ¶çµ‚äº†ã‚’æ¥µåŠ›é¿ã‘ã‚‹

.link ./firestoretx/src/fstx/panicc/main.go

.code ./firestoretx/src/fstx/panicc/main.go /START OMIT/,/END OMIT/

- ä¸€å®šæ™‚é–“ãƒ­ãƒƒã‚¯ã®é–‹æ”¾ãŒè¡Œã‚ã‚Œã¾ã›ã‚“ã€‚

> Transactions expire after 270 seconds or if idle for 60 seconds.

* ï¼ˆãŠã¾ã‘ï¼‰Transactional Cloud Tasks

* Cloud Tasks ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚·ãƒ§ãƒ³ã«å«ã‚ãŸã„

- App Engine APIï¼ˆappengine/datastoreãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼‰ã§ã¯Datastoreãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«Task Queueã®Addã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ãŸ
- Datastore Client Libraryã¯Cloud Tasksã¨é€£æºã§ããªã„(Â´ï½¥Ï‰ï½¥`)

* ä½œæˆ¦

- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ä¸€æ„ãªIDã‚’ãµã£ãŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä¿å­˜
- IDã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’Cloud Tasksãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ã«è¨­å®š
- ãƒãƒ³ãƒ‰ãƒ©ã¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å­˜åœ¨ã‚’ç¢ºèªã—ãŸã‚‰å‡¦ç†ã‚’é–‹å§‹ã€‚ç¢ºèªã§ããªã‹ã£ãŸã‚‰ãƒªãƒˆãƒ©ã‚¤
- ä¸€å®šæ™‚é–“ãƒªãƒˆãƒ©ã‚¤ã—ã¦ã‚‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã¿ãªã—ã¦çµ‚äº†

* RunInTransactionãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°

 func RunInTransactionWithTasks(ctx context.Context, f func(ctx context.Context, tx *datastore.Transaction) error, opts ...datastore.TransactionOption) error {
 	wrapperFunc := func(tx *datastore.Transaction) error {
 		txid := id.NewUUIDv4()
 
 		ctx, cancel := context.WithTimeout(ctx, 30 * time.Second)
 		defer cancel()
 
 		txStatus := &TxStatus{
 			ID:        txid,
 			CreatedAt: timeutil.NowJST(),
 		}
 
 		if err := c.MutateInTx(tx, datastore.NewInsert(Key(txStatus), txStatus)); err != nil {
 			return xerrors.Errorf(": %w", err)
 		}
 ï¼ˆã¤ã¥ãï¼‰

* 
 
 ï¼ˆã¤ã¥ãï¼‰
 		ctx = WithStatus(ctx, txStatus)
 		return f(ctx, tx)
 	}
 
 	if _, err := client.RunInTransaction(ctx, wrapperFunc, opts...); err != nil {
 		return xerrors.Errorf(": %w", err)
 	}
 
 	return nil
 }

* Task Add 

 headers := make(map[string]string)
 
 status := libtx.Status(ctx)
 if status != nil {
 	headers[TaskTxIDHeaderName] = status.ID
 	headers[TaskTxDispatchTimeHeaderName] = status.CreatedAt.Format(time.RFC3339Nano)
 }
 
 task := &taskspb.Task{
 	MessageType: &taskspb.Task_AppEngineHttpRequest{
 		AppEngineHttpRequest: &taskspb.AppEngineHttpRequest{
 			HttpMethod:  taskspb.HttpMethod_POST,
 			RelativeUri: relativeUri,
 			Body:        body,
 			Headers:     headers,
 			AppEngineRouting: &taskspb.AppEngineRouting{
 				Service: service,
 				Version: version,
 			},
 		},
 	},
 }
 ï¼ˆã¤ã¥ãï¼‰

* 

 ï¼ˆã¤ã¥ãï¼‰
 req := &taskspb.CreateTaskRequest{
 	Parent: queuePath,
 	Task:   task,
 }
 
 if _, err := client.CreateTask(ctx, req); err != nil {
 	return xerrors.Errorf(": %w", err)
 }

* Tasksãƒãƒ³ãƒ‰ãƒ©

 txID := r.Header.Get(tasksutil.TaskTxIDHeaderName)
 
 if txID != "" {
 	dispatchTime, err := time.Parse(time.RFC3339Nano, r.Header.Get(tasksutil.TaskTxDispatchTimeHeaderName))
 	if err != nil {
 		w.WriteHeader(http.StatusBadRequest)
 		return
 	}

 	txStatus := &libtx.TxStatus{ID: txID}
 	if err := client.Get(ctx, txStatus); xerrors.Is(err, domerr.ErrNotFound) {
 		if time.Now().Sub(dispatchTime) > tx.TxTimeout*2 { // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®2å€è¶…ãˆãŸã‚‰ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
 			return
 		} else {
 			w.WriteHeader(http.StatusLocked)
 			return
 		}
 	} else if err != nil {
 		w.WriteHeader(http.StatusInternalServerError)
 		return
 	}
 }
